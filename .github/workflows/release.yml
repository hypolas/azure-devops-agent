name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: docker.io
  IMAGE_NAME: hypolas/azure-devops-agent

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Get Azure DevOps Agent Version
      id: agent-version
      run: |
        # Construire le stage temporaire pour extraire la version (Linux uniquement)
        docker build --target temp-version --platform linux/amd64 -t temp-version .
        AGENT_VERSION=$(docker run --rm temp-version cat /tmp/agent_version.txt)
        echo "agent-version=$AGENT_VERSION" >> $GITHUB_OUTPUT
        echo "Azure DevOps Agent Version: $AGENT_VERSION"

    - name: Generate Build Version
      id: build-version
      run: |
        # Pour les releases, utiliser le tag comme version de build
        BUILD_VERSION="${GITHUB_REF#refs/tags/}"
        echo "build-version=$BUILD_VERSION" >> $GITHUB_OUTPUT
        echo "Build Version: $BUILD_VERSION"
        
        # Version combinée: agent-version-build-version
        COMBINED_VERSION="${{ steps.agent-version.outputs.agent-version }}-$BUILD_VERSION"
        echo "combined-version=$COMBINED_VERSION" >> $GITHUB_OUTPUT
        echo "Combined Version: $COMBINED_VERSION"

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest
          type=raw,value=${{ steps.build-version.outputs.combined-version }}
          type=raw,value=${{ steps.agent-version.outputs.agent-version }}
          type=raw,value=agent-${{ steps.agent-version.outputs.agent-version }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64,linux/arm/v7
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          INSTALL_AWS_SSM=true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << EOF
        ## 🚀 Azure DevOps Docker Agent ${{ steps.version.outputs.VERSION }}
        
        ### 🎯 Agent Information
        - **Azure DevOps Agent Version**: \`${{ steps.agent-version.outputs.agent-version }}\`
        - **Container Version**: \`${{ steps.version.outputs.VERSION }}\`
        - **Combined Version**: \`${{ steps.build-version.outputs.combined-version }}\`
        
        ### 📦 Container Images
        - **AMD64**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}-amd64\`
        - **ARM64**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}-arm64\`
        - **ARMv7**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}-armv7\`
        - **Multi-arch**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}\`
        - **Agent Version**: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.agent-version.outputs.agent-version }}\`
        
        ### ✨ Features
        - ✅ Azure DevOps Agent ${{ steps.agent-version.outputs.agent-version }} with container support
        - ⚡ Lightweight aws-ssm binary (~10MB vs ~100MB+ AWS CLI)
        - 🔐 AWS Secrets Manager integration
        - 🐳 Docker-in-Docker support
        - 🛡️ IMDSv2 security for AWS metadata
        
        ### 🔧 Usage
        \`\`\`bash
        # Par version du conteneur
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
        
        # Par version combinée (agent-container)
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.build-version.outputs.combined-version }}
        
        # Par version de l'agent Azure DevOps
        docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.agent-version.outputs.agent-version }}
        \`\`\`
        
        ### 📋 Quick Start
        \`\`\`bash
        docker run -d \\
          --name azure-agent-1 \\
          -v /var/run/docker.sock:/var/run/docker.sock \\
          -e AZP_URL="https://dev.azure.com/your-org" \\
          -e AZP_TOKEN="your-token" \\
          -e AZP_POOL="your-pool" \\
          -e AZP_AGENT_NAME="my-agent" \\
          -e AGENT_NUMBER="1" \\
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.VERSION }}
        \`\`\`
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        body_path: release_notes.md
        draft: false
        prerelease: false
        generate_release_notes: true